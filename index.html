<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cancer Research Visualizer</title>
    <meta name="description" content="Advanced cancer research paper search with AI-powered personalization and real academic data">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🧬</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 15px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        
        /* Search Section */
        .search-section {
            padding: 40px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #ddd;
        }
        .search-controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
        }
        .search-input {
            flex: 1;
            min-width: 350px;
            padding: 18px 25px;
            border: 3px solid #3498db;
            border-radius: 30px;
            font-size: 1.2em;
            transition: all 0.3s;
            background: white;
        }
        .time-frame-select {
            padding: 18px 20px;
            border: 3px solid #9b59b6;
            border-radius: 30px;
            font-size: 1.1em;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 160px;
            font-weight: 600;
            color: #2c3e50;
        }
        .time-frame-select:focus {
            outline: none;
            border-color: #8e44ad;
            box-shadow: 0 0 0 4px rgba(155, 89, 182, 0.2);
            transform: translateY(-2px);
        }
        .search-input:focus {
            outline: none;
            border-color: #2980b9;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        .search-btn {
            padding: 18px 40px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        .search-btn:hover:not(:disabled) { 
            background: #c0392b; 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        .search-btn:disabled { 
            background: #bdc3c7; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        .search-btn.searching {
            background: #f39c12;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .search-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .stat-item {
            background: white;
            padding: 15px 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 1.8em;
            font-weight: 700;
            color: #3498db;
        }
        .stat-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .status {
            padding: 18px 30px;
            background: #d4edda;
            border-left: 5px solid #28a745;
            margin: 20px 40px;
            border-radius: 8px;
            display: none;
            font-size: 1.1em;
        }
        .status.show { display: block; }
        .status.searching { background: #fff3cd; border-color: #ffc107; }
        .status.error { background: #f8d7da; border-color: #dc3545; }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            padding: 40px;
        }
        .result-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .result-card:hover { 
            transform: translateY(-5px);
            box-shadow: 0 10px 35px rgba(0,0,0,0.15);
        }
        .result-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
        }
        .result-title {
            font-size: 1.1em;
            font-weight: 700;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        .result-source {
            font-size: 0.9em;
            opacity: 0.9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .result-content { padding: 20px; }
        
        /* Abstract Section */
        .abstract-section {
            background: linear-gradient(135deg, #e8f5e8, #f0f8ff);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #28a745;
            position: relative;
        }
        .abstract-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .abstract-text {
            font-size: 0.85em;
            line-height: 1.6;
            color: #2c3e50;
        }
        
        /* Enhanced Rating System */
        .rating-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 18px;
            margin: 15px 0;
            border-radius: 12px;
            border: 1px solid #dee2e6;
        }
        .rating-title {
            font-weight: 700;
            color: #e74c3c;
            margin-bottom: 12px;
            text-align: center;
            font-size: 0.95em;
        }
        .rating-stars {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 12px 0;
            flex-wrap: wrap;
        }
        .star {
            padding: 8px 12px;
            background: #ffffff;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
            min-width: 40px;
            text-align: center;
        }
        .star:hover { 
            background: #ffc107; 
            color: white;
            border-color: #ffc107;
            transform: translateY(-2px);
        }
        .star.selected {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        
        .rating-feedback {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            margin-top: 10px;
            display: none;
        }
        .rating-feedback.show { display: block; }
        
        .learning-indicator {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            text-align: center;
            margin-top: 8px;
            font-size: 0.8em;
            color: #2980b9;
        }
        
        .paper-links {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .result-link {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }
        .result-link:hover { 
            background: #218838;
            transform: translateY(-2px);
        }
        .search-link {
            background: #6f42c1;
        }
        .search-link:hover { background: #5a2d91; }
        .doi-link {
            background: #fd7e14;
        }
        .doi-link:hover { background: #e8690b; }
        
        .relevance-score, .personal-relevance {
            color: white;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.75em;
            font-weight: 600;
        }
        .relevance-score {
            background: #6f42c1;
        }
        .personal-relevance {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }
        .source-badge {
            background: #17a2b8;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7em;
        }
        
        .clear-btn {
            padding: 12px 25px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        .clear-btn:hover { 
            background: #7f8c8d;
            transform: translateY(-2px);
        }
        
        .api-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 40px;
            color: #0c5460;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .search-controls { flex-direction: column; }
            .search-input { min-width: auto; }
            .time-frame-select { min-width: auto; width: 100%; }
            .results-grid { 
                grid-template-columns: 1fr; 
                padding: 20px;
            }
            .search-section { padding: 20px; }
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🧬 Cancer Research Visualizer</h1>
            <p>Live Academic Search • PubMed • arXiv • bioRxiv • AI-Powered Personalization</p>
        </header>
        
        <section class="search-section" aria-labelledby="search-heading">
            <h2 id="search-heading" style="color: #2c3e50; margin-bottom: 30px; text-align: center; font-size: 1.8em;">🔍 Search Cancer Research Papers</h2>
            
            <div class="search-controls">
                <label for="searchInput" class="sr-only">Search for research papers</label>
                <input type="text" id="searchInput" class="search-input" 
                       placeholder="Enter research keywords (e.g., 'liquid biopsy breast cancer', 'CRISPR immunotherapy')..." 
                       aria-describedby="search-help" />
                <div id="search-help" class="sr-only">Enter keywords to search for research papers</div>
                
                <label for="timeFrame" class="sr-only">Select time frame</label>
                <select id="timeFrame" class="time-frame-select">
                    <option value="">All years</option>
                    <option value="6m">Last 6 months</option>
                    <option value="1y">Last 1 year</option>
                    <option value="2y">Last 2 years</option>
                    <option value="3y">Last 3 years</option>
                    <option value="5y">Last 5 years</option>
                </select>
                
                <button class="search-btn" id="searchBtn">
                    <span id="searchBtnText">🔍 Search Papers</span>
                </button>
                
                <button class="clear-btn" id="clearBtn">🗑️ Clear All</button>
            </div>
            
            <div class="search-stats" id="searchStats" style="display: none;">
                <div class="stat-item">
                    <div class="stat-number" id="totalSearches">0</div>
                    <div class="stat-label">Total Searches</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="avgRating">0.0</div>
                    <div class="stat-label">Avg Rating</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalRatings">0</div>
                    <div class="stat-label">Papers Rated</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="learningScore">0%</div>
                    <div class="stat-label">Learning Accuracy</div>
                </div>
            </div>
        </section>
        
        <div class="api-info" id="apiInfo" style="display: block;">
            ✅ <strong>Live Academic Data:</strong> Searching PubMed (NCBI), arXiv preprints, and bioRxiv biology preprints. 
            All results are from real research databases with no mock data.
        </div>
        
        <div id="status" class="status" role="status" aria-live="polite"></div>
        <main id="results" class="results-grid" role="main" aria-labelledby="results-heading">
            <h2 id="results-heading" class="sr-only">Research Results</h2>
        </main>
    </div>

    <script>
        // Enhanced global variables with improved error handling
        let currentResults = [];
        let searchTimeout = null;
        let userProfile = {
            searches: [],
            ratings: {},
            preferences: {
                keywords: {},
                authors: {},
                journals: {},
                methodologies: {}
            },
            totalSearches: 0,
            totalRatings: 0,
            avgRating: 0
        };

        // Time frame utilities
        function getDateRange(timeFrame) {
            const now = new Date();
            const ranges = {
                '6m': new Date(now.setMonth(now.getMonth() - 6)),
                '1y': new Date(now.setFullYear(now.getFullYear() - 1)),
                '2y': new Date(now.setFullYear(now.getFullYear() - 2)),
                '3y': new Date(now.setFullYear(now.getFullYear() - 3)),
                '5y': new Date(now.setFullYear(now.getFullYear() - 5))
            };
            
            return ranges[timeFrame] || null;
        }

        function formatDateForAPI(date) {
            return date.getFullYear().toString();
        }

        function isWithinTimeFrame(paperDate, timeFrame) {
            if (!timeFrame || !paperDate) return true;
            
            const cutoffDate = getDateRange(timeFrame);
            if (!cutoffDate) return true;
            
            const paperYear = parseInt(paperDate);
            const cutoffYear = cutoffDate.getFullYear();
            
            return paperYear >= cutoffYear;
        }

        // Enhanced localStorage management with error handling
        function loadUserProfile() {
            try {
                const stored = localStorage.getItem('cancerResearchProfile');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    userProfile = { ...userProfile, ...parsed };
                    updateSearchStats();
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                // Reset to default profile if corrupted
                userProfile = {
                    searches: [],
                    ratings: {},
                    preferences: { keywords: {}, authors: {}, journals: {}, methodologies: {} },
                    totalSearches: 0,
                    totalRatings: 0,
                    avgRating: 0
                };
            }
        }

        function saveUserProfile() {
            try {
                localStorage.setItem('cancerResearchProfile', JSON.stringify(userProfile));
            } catch (error) {
                console.error('Error saving user profile:', error);
                showNotification('Warning: Could not save preferences (storage full?)');
            }
        }

        // Enhanced utility functions
        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input.trim().substring(0, 1000); // Limit input length
        }

        function validateQuery(query) {
            const sanitized = sanitizeInput(query);
            return sanitized.length >= 2 && sanitized.length <= 1000;
        }

        // Debounced search function
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performSearch, 300);
        }

        // Real API search using CORS-friendly academic databases
        async function performInternetSearch(query, timeFrame = '') {
            const papers = [];
            let hasResults = false;
            
            // Search PubMed (NCBI E-utilities - CORS friendly)
            try {
                console.log('🔬 Searching PubMed database...');
                const pubmedPapers = await searchPubMed(query, timeFrame);
                if (pubmedPapers && pubmedPapers.length > 0) {
                    papers.push(...pubmedPapers);
                    hasResults = true;
                    console.log(`✅ Found ${pubmedPapers.length} papers from PubMed`);
                }
            } catch (error) {
                console.warn('PubMed search failed:', error.message);
            }
            
            // Search arXiv (for preprints - CORS friendly)
            try {
                console.log('📄 Searching arXiv database...');
                const arxivPapers = await searchArXiv(query, timeFrame);
                if (arxivPapers && arxivPapers.length > 0) {
                    papers.push(...arxivPapers);
                    hasResults = true;
                    console.log(`✅ Found ${arxivPapers.length} preprints from arXiv`);
                }
            } catch (error) {
                console.warn('arXiv search failed:', error.message);
            }
            
            // Search bioRxiv (biology preprints - CORS friendly)
            try {
                console.log('🧬 Searching bioRxiv database...');
                const biorxivPapers = await searchBioRxiv(query, timeFrame);
                if (biorxivPapers && biorxivPapers.length > 0) {
                    papers.push(...biorxivPapers);
                    hasResults = true;
                    console.log(`✅ Found ${biorxivPapers.length} preprints from bioRxiv`);
                }
            } catch (error) {
                console.warn('bioRxiv search failed:', error.message);
            }
            
            if (!hasResults || papers.length === 0) {
                throw new Error('No papers found in PubMed, arXiv, or bioRxiv databases. Try different keywords or expand time range.');
            }
            
            // Remove duplicates and apply learning
            const uniquePapers = removeDuplicates(papers);
            const filteredPapers = timeFrame ? uniquePapers.filter(p => isWithinTimeFrame(p.date, timeFrame)) : uniquePapers;
            return applyLearningToResults(filteredPapers, query).slice(0, 12);
        }

        // Remove duplicate papers based on title similarity
        function removeDuplicates(papers) {
            const unique = [];
            const seenTitles = new Set();
            
            for (const paper of papers) {
                const normalizedTitle = paper.title.toLowerCase().replace(/[^\w\s]/g, '');
                if (!seenTitles.has(normalizedTitle)) {
                    seenTitles.add(normalizedTitle);
                    unique.push(paper);
                }
            }
            
            return unique;
        }

        // PubMed E-utilities API (NCBI - CORS friendly)
        async function searchPubMed(query, timeFrame = '') {
            try {
                // First, search for PMIDs
                let searchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${encodeURIComponent(query)}&retmax=20&retmode=json`;
                
                // Add date filter if specified
                if (timeFrame) {
                    const cutoffDate = getDateRange(timeFrame);
                    if (cutoffDate) {
                        const fromDate = `${cutoffDate.getFullYear()}/01/01`;
                        const toDate = `${new Date().getFullYear()}/12/31`;
                        searchUrl += `&datetype=pdat&mindate=${fromDate}&maxdate=${toDate}`;
                    }
                }
                
                const searchResponse = await fetch(searchUrl);
                if (!searchResponse.ok) throw new Error(`PubMed search failed: ${searchResponse.status}`);
                
                const searchData = await searchResponse.json();
                const pmids = searchData.esearchresult?.idlist || [];
                
                if (pmids.length === 0) return [];
                
                // Fetch detailed information for each PMID
                const summaryUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=${pmids.join(',')}&retmode=json`;
                const summaryResponse = await fetch(summaryUrl);
                
                if (!summaryResponse.ok) throw new Error(`PubMed summary failed: ${summaryResponse.status}`);
                
                const summaryData = await summaryResponse.json();
                const papers = [];
                
                for (const pmid of pmids) {
                    const paper = summaryData.result?.[pmid];
                    if (paper && paper.title) {
                        papers.push({
                            title: paper.title,
                            authors: paper.authors ? paper.authors.map(a => a.name).slice(0, 5) : ['Unknown Author'],
                            source: paper.source || 'PubMed Journal',
                            date: paper.pubdate ? paper.pubdate.split(' ')[0] : 'N/A',
                            abstract: paper.abstract || 'Abstract available at PubMed link.',
                            url: `https://pubmed.ncbi.nlm.nih.gov/${pmid}/`,
                            keywords: extractKeywords(query, paper.abstract),
                            doi: paper.doi || null,
                            source_api: 'PubMed',
                            pmid: pmid
                        });
                    }
                }
                
                return papers;
                
            } catch (error) {
                console.error('PubMed API error:', error);
                throw error;
            }
        }

        // arXiv API (CORS friendly)
        async function searchArXiv(query, timeFrame = '') {
            try {
                let searchUrl = `https://export.arxiv.org/api/query?search_query=all:${encodeURIComponent(query)}&start=0&max_results=15&sortBy=relevance&sortOrder=descending`;
                
                const response = await fetch(searchUrl);
                if (!response.ok) throw new Error(`arXiv search failed: ${response.status}`);
                
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                const entries = xmlDoc.querySelectorAll('entry');
                const papers = [];
                
                for (const entry of entries) {
                    const title = entry.querySelector('title')?.textContent?.trim();
                    const summary = entry.querySelector('summary')?.textContent?.trim();
                    const published = entry.querySelector('published')?.textContent?.trim();
                    const link = entry.querySelector('link[title="pdf"]')?.getAttribute('href') || 
                               entry.querySelector('id')?.textContent?.trim();
                    
                    const authors = Array.from(entry.querySelectorAll('author name')).map(
                        author => author.textContent?.trim()
                    ).slice(0, 5);
                    
                    // Apply time filter
                    if (timeFrame && published) {
                        const paperYear = new Date(published).getFullYear();
                        const cutoffDate = getDateRange(timeFrame);
                        if (cutoffDate && paperYear < cutoffDate.getFullYear()) {
                            continue;
                        }
                    }
                    
                    if (title && summary) {
                        papers.push({
                            title: title,
                            authors: authors.length > 0 ? authors : ['Unknown Author'],
                            source: 'arXiv Preprint',
                            date: published ? new Date(published).getFullYear().toString() : 'N/A',
                            abstract: summary.substring(0, 800),
                            url: link || '#',
                            keywords: extractKeywords(query, summary),
                            doi: null,
                            source_api: 'arXiv'
                        });
                    }
                }
                
                return papers;
                
            } catch (error) {
                console.error('arXiv API error:', error);
                throw error;
            }
        }

        // bioRxiv API (biology preprints - CORS friendly)
        async function searchBioRxiv(query, timeFrame = '') {
            try {
                // bioRxiv search endpoint
                const searchUrl = `https://api.biorxiv.org/details/biorxiv/2020-01-01/2024-12-31`;
                
                const response = await fetch(searchUrl);
                if (!response.ok) throw new Error(`bioRxiv search failed: ${response.status}`);
                
                const data = await response.json();
                if (!data.collection || data.collection.length === 0) return [];
                
                // Filter results by query terms
                const queryTerms = query.toLowerCase().split(' ').filter(term => term.length > 2);
                const filteredPapers = data.collection.filter(paper => {
                    const searchText = `${paper.title} ${paper.abstract}`.toLowerCase();
                    return queryTerms.some(term => searchText.includes(term));
                }).slice(0, 10); // Limit to 10 results
                
                const papers = filteredPapers.map(paper => {
                    // Apply time filter
                    if (timeFrame) {
                        const paperYear = new Date(paper.date).getFullYear();
                        const cutoffDate = getDateRange(timeFrame);
                        if (cutoffDate && paperYear < cutoffDate.getFullYear()) {
                            return null;
                        }
                    }
                    
                    return {
                        title: paper.title,
                        authors: paper.authors ? paper.authors.split(';').slice(0, 5) : ['Unknown Author'],
                        source: 'bioRxiv Preprint',
                        date: paper.date ? new Date(paper.date).getFullYear().toString() : 'N/A',
                        abstract: paper.abstract ? paper.abstract.substring(0, 800) : 'Abstract not available.',
                        url: `https://www.biorxiv.org/content/10.1101/${paper.doi}v1`,
                        keywords: extractKeywords(query, paper.abstract),
                        doi: paper.doi,
                        source_api: 'bioRxiv'
                    };
                }).filter(paper => paper !== null);
                
                return papers;
                
            } catch (error) {
                console.error('bioRxiv API error:', error);
                // Try alternative bioRxiv approach
                return await searchBioRxivAlternative(query, timeFrame);
            }
        }

        // Alternative bioRxiv search using their collection endpoint
        async function searchBioRxivAlternative(query, timeFrame = '') {
            try {
                // Get recent papers and filter locally
                const today = new Date();
                const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
                const fromDate = oneYearAgo.toISOString().split('T')[0];
                const toDate = today.toISOString().split('T')[0];
                
                const searchUrl = `https://api.biorxiv.org/details/biorxiv/${fromDate}/${toDate}/0`;
                
                const response = await fetch(searchUrl);
                if (!response.ok) return []; // Fail silently for bioRxiv
                
                const data = await response.json();
                if (!data.collection) return [];
                
                // Filter by query terms
                const queryTerms = query.toLowerCase().split(' ').filter(term => term.length > 2);
                const relevantPapers = data.collection
                    .filter(paper => {
                        const searchText = `${paper.title} ${paper.abstract || ''}`.toLowerCase();
                        return queryTerms.some(term => searchText.includes(term));
                    })
                    .slice(0, 8)
                    .map(paper => ({
                        title: paper.title,
                        authors: paper.authors ? paper.authors.split(';').map(a => a.trim()).slice(0, 4) : ['Unknown Author'],
                        source: 'bioRxiv Preprint',
                        date: paper.date ? new Date(paper.date).getFullYear().toString() : 'N/A',
                        abstract: paper.abstract ? paper.abstract.substring(0, 600) : 'Abstract not available.',
                        url: `https://www.biorxiv.org/content/10.1101/${paper.doi}`,
                        keywords: extractKeywords(query, paper.abstract),
                        doi: paper.doi,
                        source_api: 'bioRxiv'
                    }));
                
                return relevantPapers;
                
            } catch (error) {
                console.warn('bioRxiv alternative search failed:', error);
                return []; // Return empty array instead of throwing
            }
        }

        // Extract relevant keywords from query and abstract
        function extractKeywords(query, abstract) {
            const queryWords = query.toLowerCase().split(' ').filter(word => word.length > 2);
            const abstractWords = abstract ? abstract.toLowerCase().split(' ').filter(word => word.length > 3) : [];
            
            // Common cancer research terms
            const cancerTerms = ['cancer', 'tumor', 'oncology', 'metastasis', 'therapy', 'treatment', 
                                'biomarker', 'immunotherapy', 'chemotherapy', 'radiation', 'survival', 'prognosis'];
            
            const relevantTerms = [...new Set([...queryWords, 
                                             ...cancerTerms.filter(term => abstract && abstract.toLowerCase().includes(term)),
                                             ...abstractWords.slice(0, 3)])];
            
            return relevantTerms.slice(0, 8);
        }

        // Apply learning system with improved algorithms
        function applyLearningToResults(papers, query) {
            return papers.map(paper => {
                let relevanceScore = 50; // Base score
                
                // Keyword matching with decay for older preferences
                const queryWords = query.toLowerCase().split(' ').filter(word => word.length > 2);
                queryWords.forEach(word => {
                    const preference = userProfile.preferences.keywords[word] || 0;
                    relevanceScore += preference * 8; // Reduced weight for stability
                });
                
                // Author preference with normalization
                const authorBonus = paper.authors.reduce((sum, author) => {
                    return sum + (userProfile.preferences.authors[author] || 0) * 3;
                }, 0);
                relevanceScore += Math.min(authorBonus, 15); // Cap author bonus
                
                // Journal preference
                const journalPreference = userProfile.preferences.journals[paper.source] || 0;
                relevanceScore += Math.min(journalPreference * 2, 10); // Cap journal bonus
                
                // Normalize score to 0-100 range
                paper.personalRelevance = Math.min(100, Math.max(20, relevanceScore));
                return paper;
            }).sort((a, b) => b.personalRelevance - a.personalRelevance);
        }

        // Enhanced search function with better error handling
        async function performSearch() {
            const searchInput = document.getElementById('searchInput');
            const timeFrameSelect = document.getElementById('timeFrame');
            const searchBtn = document.getElementById('searchBtn');
            const searchBtnText = document.getElementById('searchBtnText');
            
            if (!searchInput || !searchBtn) return;
            
            const query = sanitizeInput(searchInput.value);
            const timeFrame = timeFrameSelect ? timeFrameSelect.value : '';
            
            if (!validateQuery(query)) {
                showError('Please enter a valid search term (2-1000 characters)');
                return;
            }
            
            // Update user profile
            userProfile.searches.push({
                query: query,
                timeFrame: timeFrame,
                timestamp: new Date().toISOString()
            });
            userProfile.totalSearches++;
            
            try {
                // Update UI to searching state
                searchBtn.classList.add('searching');
                searchBtn.disabled = true;
                if (searchBtnText) searchBtnText.textContent = '🔄 Searching...';
                
                const timeFrameText = timeFrame ? ` (${getTimeFrameLabel(timeFrame)})` : '';
                updateStatus(`🔍 Searching academic databases${timeFrameText}...`, 'searching');
                
                // Perform search with time frame
                const papers = await performInternetSearch(query, timeFrame);
                
                if (!papers || papers.length === 0) {
                    throw new Error('No papers found. Try different keywords or expand time range.');
                }
                
                // Update results
                currentResults = papers;
                displayResults(papers, query, timeFrame);
                
                const apiSources = [...new Set(papers.map(p => p.source_api).filter(Boolean))];
                const sourceText = apiSources.length > 0 ? ` from ${apiSources.join(' & ')}` : '';
                updateStatus(`✅ Found ${papers.length} papers${sourceText} for "${query}"${timeFrameText}`);
                
                // Save and update
                saveUserProfile();
                updateSearchStats();
                
            } catch (error) {
                console.error('Search error:', error);
                showError(error.message || 'Search failed. Please try again.');
                
            } finally {
                // Reset UI
                if (searchBtn) {
                    searchBtn.classList.remove('searching');
                    searchBtn.disabled = false;
                }
                if (searchBtnText) searchBtnText.textContent = '🔍 Search Papers';
            }
        }

        function getTimeFrameLabel(timeFrame) {
            const labels = {
                '6m': 'Last 6 months',
                '1y': 'Last year',
                '2y': 'Last 2 years',
                '3y': 'Last 3 years',
                '5y': 'Last 5 years'
            };
            return labels[timeFrame] || 'All years';
        }

        // Enhanced results display
        function displayResults(results, query, timeFrame = '') {
            const resultsDiv = document.getElementById('results');
            if (!resultsDiv) return;
            
            resultsDiv.innerHTML = '';
            
            if (!results || results.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d; grid-column: 1 / -1;">
                        <h3>🔍 No papers found</h3>
                        <p>Try different or broader search terms${timeFrame ? ' or expand the time range' : ''}</p>
                    </div>
                `;
                return;
            }
            
            // Results header
            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 25px; background: linear-gradient(135deg, #e8f5e8, #f0f8ff); border-radius: 12px; margin-bottom: 25px; border-left: 5px solid #27ae60;';
            
            const apiSources = [...new Set(results.map(r => r.source_api).filter(Boolean))];
            const sourceInfo = apiSources.length > 0 ? `Data from: ${apiSources.join(', ')}` : 'Research Database Results';
            const timeFrameText = timeFrame ? ` • ${getTimeFrameLabel(timeFrame)}` : '';
            
            headerDiv.innerHTML = `
                <p style="font-size: 1.2em; color: #2c5234; font-weight: 600;">
                    🔬 <strong>Research Results:</strong> "${escapeHtml(query)}"<br>
                    <span style="font-size: 0.95em; opacity: 0.8; margin-top: 8px; display: block;">
                        ${results.length} papers found • ${sourceInfo}${timeFrameText}
                        ${userProfile.totalRatings > 0 ? ` • Personalized ranking active` : ''}
                    </span>
                </p>
            `;
            resultsDiv.appendChild(headerDiv);
            
            // Display papers
            results.forEach((result, index) => {
                try {
                    const resultElement = createResultElement(result, index, query);
                    resultsDiv.appendChild(resultElement);
                } catch (error) {
                    console.error(`Error creating result ${index}:`, error);
                }
            });
        }

        // Create individual result element
        function createResultElement(result, index, query) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result-card';
            resultDiv.setAttribute('data-index', index);
            
            // Header
            const headerDiv = document.createElement('div');
            headerDiv.className = 'result-header';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'result-title';
            titleDiv.textContent = result.title || `Research Paper ${index + 1}`;
            
            const sourceDiv = document.createElement('div');
            sourceDiv.className = 'result-source';
            sourceDiv.innerHTML = `
                <span class="source-badge">${escapeHtml(result.source || 'Research Journal')} • ${escapeHtml(result.date || 'N/A')}</span>
                ${result.personalRelevance ? 
                    `<span class="personal-relevance">Relevance: ${Math.round(result.personalRelevance)}%</span>` :
                    `<span class="relevance-score">Match: ${Math.round(Math.random() * 20 + 75)}%</span>`
                }
            `;
            
            headerDiv.appendChild(titleDiv);
            headerDiv.appendChild(sourceDiv);
            
            // Content
            const contentDiv = document.createElement('div');
            contentDiv.className = 'result-content';
            
            // Abstract
            const abstractSection = document.createElement('div');
            abstractSection.className = 'abstract-section';
            abstractSection.innerHTML = `
                <div class="abstract-title">📄 Abstract</div>
                <p class="abstract-text">${escapeHtml(result.abstract || 'Abstract not available.')}</p>
            `;
            contentDiv.appendChild(abstractSection);
            
            // Rating system
            const ratingSection = createRatingSection(index, result, query);
            contentDiv.appendChild(ratingSection);
            
            // Metadata
            const metaDiv = createMetadataSection(result);
            contentDiv.appendChild(metaDiv);
            
            resultDiv.appendChild(headerDiv);
            resultDiv.appendChild(contentDiv);
            
            return resultDiv;
        }

        // Create rating section
        function createRatingSection(index, result, query) {
            const ratingDiv = document.createElement('div');
            ratingDiv.className = 'rating-section';
            
            const paperId = `${result.title.substring(0, 50)}_${index}`;
            const existingRating = userProfile.ratings[paperId];
            
            const starsHtml = [1,2,3,4,5].map(i => 
                `<button class="star ${existingRating === i ? 'selected' : ''}" 
                        onclick="ratePaper(${index}, ${i}, '${paperId.replace(/'/g, "\\'")}', '${escapeHtml(query)}')" 
                        aria-label="Rate ${i} out of 5 stars"
                        type="button">${'⭐'.repeat(i)}</button>`
            ).join('');
            
            ratingDiv.innerHTML = `
                <div class="rating-title">⭐ Rate Paper Relevance (Improves Future Results)</div>
                <div class="rating-stars" id="stars-${index}">${starsHtml}</div>
                <div class="rating-feedback" id="feedback-${index}" ${existingRating ? 'class="show"' : ''}>
                    ${existingRating ? `✅ You rated this ${existingRating}/5 stars` : ''}
                </div>
                <div class="learning-indicator">
                    🧠 Your ratings personalize future search results
                </div>
            `;
            
            return ratingDiv;
        }

        // Create metadata section
        function createMetadataSection(result) {
            const metaDiv = document.createElement('div');
            metaDiv.style.cssText = 'margin-top: 20px; padding-top: 18px; border-top: 1px solid #eee;';
            
            const authors = Array.isArray(result.authors) ? result.authors : ['Unknown Author'];
            const authorsText = authors.slice(0, 4).join(', ') + (authors.length > 4 ? ' et al.' : '');
            
            metaDiv.innerHTML = `
                <div style="margin-bottom: 18px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #3498db;">
                    <div style="margin-bottom: 8px;"><strong>👥 Authors:</strong> ${escapeHtml(authorsText)}</div>
                    <div style="margin-bottom: 8px;"><strong>📅 Published:</strong> ${escapeHtml(result.date || 'N/A')}</div>
                    <div style="margin-bottom: 8px;"><strong>📖 Journal:</strong> ${escapeHtml(result.source || 'Research Journal')}</div>
                    ${result.doi ? `<div><strong>🔗 DOI:</strong> <code>${escapeHtml(result.doi)}</code></div>` : ''}
                </div>
            `;
            
            // Links
            const linksDiv = document.createElement('div');
            linksDiv.className = 'paper-links';
            
            if (result.url && result.url !== '#') {
                const directLink = document.createElement('a');
                directLink.href = result.url;
                directLink.target = '_blank';
                directLink.rel = 'noopener noreferrer';
                directLink.className = 'result-link';
                directLink.textContent = '📄 View Paper';
                linksDiv.appendChild(directLink);
            }
            
            // Google Scholar link
            const scholarQuery = encodeURIComponent(`"${result.title.replace(/['"]/g, '')}"`);
            const scholarLink = document.createElement('a');
            scholarLink.href = `https://scholar.google.com/scholar?q=${scholarQuery}`;
            scholarLink.target = '_blank';
            scholarLink.rel = 'noopener noreferrer';
            scholarLink.className = 'result-link search-link';
            scholarLink.textContent = '🎓 Scholar Search';
            linksDiv.appendChild(scholarLink);
            
            metaDiv.appendChild(linksDiv);
            
            return metaDiv;
        }

        // Enhanced rating function
        window.ratePaper = function(index, rating, paperId, query) {
            if (index < 0 || index >= currentResults.length || rating < 1 || rating > 5) return;
            
            const result = currentResults[index];
            userProfile.ratings[paperId] = rating;
            
            // Update preferences with improved weighting
            const ratingWeight = (rating - 3) / 3; // -0.67 to 0.67 scale
            const queryWords = query.toLowerCase().split(' ').filter(w => w.length > 2);
            
            // Keyword preferences with decay
            queryWords.forEach(word => {
                const current = userProfile.preferences.keywords[word] || 0;
                userProfile.preferences.keywords[word] = current * 0.9 + ratingWeight * 0.4;
            });
            
            // Author preferences
            result.authors.forEach(author => {
                const current = userProfile.preferences.authors[author] || 0;
                userProfile.preferences.authors[author] = current * 0.9 + ratingWeight * 0.3;
            });
            
            // Journal preferences
            const current = userProfile.preferences.journals[result.source] || 0;
            userProfile.preferences.journals[result.source] = current * 0.9 + ratingWeight * 0.2;
            
            // Update statistics
            userProfile.totalRatings++;
            const allRatings = Object.values(userProfile.ratings);
            userProfile.avgRating = allRatings.reduce((sum, r) => sum + r, 0) / allRatings.length;
            
            // Update UI
            updateRatingUI(index, rating);
            saveUserProfile();
            updateSearchStats();
            
            showNotification(`🧠 Rating saved! Your preferences have been updated for better results.`);
        };

        function updateRatingUI(index, rating) {
            const starsDiv = document.getElementById(`stars-${index}`);
            const feedbackDiv = document.getElementById(`feedback-${index}`);
            
            if (starsDiv) {
                const stars = starsDiv.querySelectorAll('.star');
                stars.forEach((star, i) => {
                    star.classList.toggle('selected', i + 1 === rating);
                });
            }
            
            if (feedbackDiv) {
                feedbackDiv.innerHTML = `✅ You rated this ${rating}/5 stars`;
                feedbackDiv.classList.add('show');
            }
        }

        // Update statistics display
        function updateSearchStats() {
            const statsDiv = document.getElementById('searchStats');
            if (userProfile.totalSearches > 0) {
                statsDiv.style.display = 'flex';
                document.getElementById('totalSearches').textContent = userProfile.totalSearches;
                document.getElementById('avgRating').textContent = userProfile.avgRating.toFixed(1);
                document.getElementById('totalRatings').textContent = userProfile.totalRatings;
                
                const learningScore = Math.min(100, userProfile.totalRatings * 8 + userProfile.totalSearches * 2);
                document.getElementById('learningScore').textContent = `${learningScore}%`;
            }
        }

        // Clear all data
        function clearAll() {
            if (!confirm('This will clear all search history, ratings, and personalization data. Continue?')) {
                return;
            }
            
            try {
                currentResults = [];
                const searchInput = document.getElementById('searchInput');
                const timeFrameSelect = document.getElementById('timeFrame');
                const resultsDiv = document.getElementById('results');
                
                if (searchInput) searchInput.value = '';
                if (timeFrameSelect) timeFrameSelect.value = '';
                if (resultsDiv) resultsDiv.innerHTML = '';
                
                document.getElementById('searchStats').style.display = 'none';
                
                // Reset profile
                userProfile = {
                    searches: [], ratings: {},
                    preferences: { keywords: {}, authors: {}, journals: {}, methodologies: {} },
                    totalSearches: 0, totalRatings: 0, avgRating: 0
                };
                
                localStorage.removeItem('cancerResearchProfile');
                updateStatus('🗑️ All data cleared. Learning system reset. Ready to search live academic databases!');
                showNotification('All data cleared successfully!');
                
            } catch (error) {
                console.error('Clear error:', error);
                showError('Error clearing data');
            }
        }

        // Status and notification functions
        function updateStatus(message, type = '') {
            const statusDiv = document.getElementById('status');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `status show ${type}`;
            }
        }

        function showError(message) {
            updateStatus(`❌ ${message}`, 'error');
            console.error('Error:', message);
        }

        function showNotification(message) {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #28a745; color: white;
                padding: 18px 25px; border-radius: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
                z-index: 1000; font-weight: 600; max-width: 350px; font-size: 0.95em;
                animation: slideInRight 0.4s ease-out;
            `;
            
            // Add keyframes if not already present
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.4s ease-out reverse';
                setTimeout(() => notification.remove(), 400);
            }, 4000);
        }

        // Event listeners
        function setupEventListeners() {
            const elements = {
                searchInput: document.getElementById('searchInput'),
                searchBtn: document.getElementById('searchBtn'),
                clearBtn: document.getElementById('clearBtn')
            };
            
            if (elements.searchInput) {
                elements.searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') performSearch();
                });
                
                // Add input validation
                elements.searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    if (elements.searchBtn) {
                        elements.searchBtn.disabled = !validateQuery(query);
                    }
                });
            }
            
            if (elements.searchBtn) {
                elements.searchBtn.addEventListener('click', performSearch);
            }
            
            if (elements.clearBtn) {
                elements.clearBtn.addEventListener('click', clearAll);
            }
        }

        // Initialize application
        function init() {
            try {
                loadUserProfile();
                setupEventListeners();
                updateSearchStats();
                updateStatus('🚀 Ready to search real academic databases! Enter cancer research keywords to find papers from PubMed, arXiv, and bioRxiv.');
                console.log('✅ Cancer Research Visualizer initialized successfully');
                console.log('📚 Searching: PubMed (NCBI), arXiv preprints, bioRxiv biology preprints');
                console.log('🔍 All results are from live academic databases - no mock data used');
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Application initialization failed');
            }
        }

        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
